<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C/DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja">
  <head>
    <meta http-equiv = "Content-Type" content = "text/html; charset=utf-8" />
    <meta http-equiv = "Content-Style-Type" content = "text/css" />
    <meta http-equiv = "Content-Script-Type" content = "text/javascript" />
  </head>
  <body>
    <h1>sworks.mqo.bone_system</h1>
    <!-- Generated by Ddoc from src\sworks\mqo\bone_system.d -->
<p class="summary-sec">MikotoModel を動かす為にボーンを準備する。
</p>

<span class="summary-header-sec version-sec">0.0011(dmd2.060)
</span><br />


<span class="summary-header-sec date-sec">2012-Aug-16 02:48:01
</span><br />


<span class="summary-header-sec authors-sec">KUMA
</span><br />


<span class="summary-header-sec license-sec">CC0</span><br />



<dl class="module-members-sec"><dt><span class="decl">struct <span class="psymbol">BoneSet</span>
;
</span></dt>

<dd><p class="summary-sec">ボーンの名前(マテリアル名)と BoneSystem.bones でのインデックス値を紐付けするための一時オブジェクト。<br />

 MikotoMotion のモーションを適用する際に参照される。<br />
</p>


<dl class="members-sec"><dt><span class="decl">BoneSystem <span class="psymbol">bsys</span>
;
</span></dt>

<dd><p class="summary-sec">対象となる BoneSystem</p>


</dd>
<dt><span class="decl">int[immutable(byte)[]] <span class="psymbol">bone_id</span>
;
</span></dt>

<dd><p class="summary-sec">マテリアル名 -&gt; インデックス</p>


</dd>
<dt><span class="decl">immutable(byte)[][] <span class="psymbol">roots</span>
;
</span></dt>

<dd><p class="summary-sec">bsys のルートボーンとその兄弟ボーンの名前を格納している。<br />

 モーション適用時、ルートボーンのみは平行移動するが、
 mkm ファイル内で兄弟ボーンの内どれが最上位とされているのか不明の為、全て列挙しておく。<br />
</p>


</dd>
</dl>

</dd>
<dt><span class="decl">class <span class="psymbol">BoneSystem</span>
;
</span></dt>

<dd><p class="summary-sec">あるルートボーンとその子ボーンを管理する。<br />

</p>

<p class="bug-sec">頂点情報は、<span class="psymbol">BoneSystem</span>
 が管理している。(なんとなく違和感があるので変えるかも。)<br />

   Bone 下にスキンのインデックス、マテリアル情報も持たせている。</p>

<dl class="members-sec"><dt><span class="decl">Bone <span class="psymbol">root</span>
;
</span></dt>

<dd><p class="summary-sec">最上位のボーン</p>


</dd>
<dt><span class="decl">SdefVertex[][] <span class="psymbol">skins</span>
;
</span></dt>

<dd><p class="summary-sec">bones で使われる全スキン。由来する ObjectChunk 毎に分類してある。</p>


</dd>
<dt><span class="decl">Bone[] <span class="psymbol">bones</span>
;
</span></dt>

<dd><p class="summary-sec">このシステムに含まれる全てのボーン</p>


</dd>
<dt><span class="decl">TranslateMotion <span class="psymbol">world_translate</span>
;
</span></dt>

<dd><p class="summary-sec">ローカル座標の平行移動運動</p>


</dd>
<dt><span class="decl">RotateMotion <span class="psymbol">world_rotate</span>
;
</span></dt>

<dd><p class="summary-sec">ローカル座標の回転移動運動</p>


</dd>
<dt><span class="decl">TranslateMotion <span class="psymbol">root_translate</span>
;
</span></dt>

<dd><p class="summary-sec">ルートのみ平行移動がある。</p>


</dd>
<dt><span class="decl">Tranf <span class="psymbol">root_world</span>
;
</span></dt>

<dd><p class="summary-sec">ローカル座標の変換用</p>


</dd>
<dt><span class="decl">this(Bone[] <span class="param">bones</span>
);
</span></dt>

<dd><b>Params:</b><br />
<table border="1" frame="void" rules="rows" class="params"><tr><td class="params_id">Bone[] <span class="param">bones</span>
</td>

<td><span class="param">bones</span>
[0] がルートとする。</td></tr>
</table><br />



</dd>
<dt><span class="decl">void <span class="psymbol">update</span>
(float <span class="param">f</span>
);
</span></dt>

<dd><p class="summary-sec">システムの変換行列を更新する。</p>


</dd>
</dl>

</dd>
<dt><span class="decl">class <span class="psymbol">Bone</span>
;
</span></dt>

<dd><p class="summary-sec">Mikoto のボーン。斜辺の対角が原点。<br />

 第二長辺が、Z軸正の向き。<br />

 最短辺と第二長辺の外積が X軸正の向きになっていると思われる。たぶん。<br />

</p>

<p class="bug-sec">現在スキンのインデックス値も保持しているが、なんとなく違和感があるので変えるかも。<br />
</p>

<dl class="members-sec"><dt><span class="decl">int <span class="psymbol">id</span>
;
</span></dt>

<dd><p class="summary-sec">0 がルートとなる、ボーンの ID。BoneSystem.bones のインデックス値。</p>


</dd>
<dt><span class="decl">Bone <span class="psymbol">parent</span>
;
</span></dt>

<dd><p class="summary-sec">親ボーン。</p>


</dd>
<dt><span class="decl">Bone[] <span class="psymbol">children</span>
;
</span></dt>

<dd><p class="summary-sec">子ボーン。</p>


</dd>
<dt><span class="decl">Bone <span class="psymbol">big_brother</span>
;
</span></dt>

<dd><p class="summary-sec">兄ボーン</p>


</dd>
<dt><span class="decl">Bone <span class="psymbol">little_brother</span>
;
</span></dt>

<dd><p class="summary-sec">弟ボーン</p>


</dd>
<dt><span class="decl">Tranf <span class="psymbol">localize</span>
;
</span></dt>

<dd><p class="summary-sec">一般ワールド座標 -&gt; origin を原点とするローカル座標への変換</p>


</dd>
<dt><span class="decl">Vector3f <span class="psymbol">globalize</span>
;
</span></dt>

<dd><p class="summary-sec">ローカル座標 -&gt; 一つ上のボーンのローカル座標へ。</p>


</dd>
<dt><span class="decl">Tranf <span class="psymbol">currentGlobalize</span>
;
</span></dt>

<dd><p class="summary-sec">アニメーション用にアップデートされる。</p>


</dd>
<dt><span class="decl">Matrix4f <span class="psymbol">transform</span>
;
</span></dt>

<dd><p class="summary-sec">変換行列の最終的な変形結果が格納される。<br />

 シェーダなどから、これを参照する。</p>


</dd>
<dt><span class="decl">RotateMotion <span class="psymbol">motion</span>
;
</span></dt>

<dd><p class="summary-sec">現在適用中のモーション。ルートボーン以外は平行移動しない。<br />

 ボーンの先端(ローカル座標のZ軸正の向き)がワールド座標の Z軸正の向きと一致する位置からの回転を示している。</p>


</dd>
<dt><span class="decl">OBBox <span class="psymbol">bbox</span>
;
</span></dt>

<dd><p class="summary-sec">頂点を内包するバウンディングボックス。当り判定用</p>


</dd>
<dt><span class="decl">Vector3f <span class="psymbol">centering</span>
;
</span></dt>

<dd><p class="summary-sec">当り判定用</p>


</dd>
<dt><span class="decl">SdefSkin[] <span class="psymbol">parts</span>
;
</span></dt>

<dd><p class="summary-sec">このボーンに所属するモデル。スキン毎に分類されている。</p>


</dd>
<dt><span class="decl">this(int <span class="param">id</span>
, Vector3!(float)[] <span class="param">boneV</span>
, uint[] <span class="param">boneF</span>
, Bone <span class="param">parent</span>
);
</span></dt>

<dd><p class="summary-sec">vertex[ face[0] ] が原点、vertex[ face[1] ] がボーン先端。</p>


</dd>
<dt><span class="decl">void <span class="psymbol">update</span>
(float <span class="param">f</span>
, ref const(Tranf) <span class="param">parent_globalize</span>
);
</span></dt>

<dd><p class="summary-sec">transform を更新する。</p>


</dd>
</dl>

</dd>
<dt><span class="decl">struct <span class="psymbol">SdefVertex</span>
;
</span></dt>

<dd><p class="summary-sec">頂点情報
</p>

<b>ToDo:</b><br />

今後、メンバを増やしていく予定。<br />
<br />


<dl class="members-sec"><dt><span class="decl">Vector3f <span class="psymbol">pos</span>
;
</span></dt>

<dd><p class="summary-sec">位置</p>


</dd>
<dt><span class="decl">UVf <span class="psymbol">uv</span>
;
</span></dt>

<dd><p class="summary-sec">テクスチャ座標</p>


</dd>
<dt><span class="decl">int[4u] <span class="psymbol">mat</span>
;
</span></dt>

<dd><p class="summary-sec">影響を受ける変換行列</p>


</dd>
<dt><span class="decl">float[4u] <span class="psymbol">influence</span>
;
</span></dt>

<dd><p class="summary-sec">それぞれの行列の影響度。∫= 1</p>


</dd>
</dl>

</dd>
<dt><span class="decl">struct <span class="psymbol">SdefSkin</span>
;
</span></dt>

<dd><p class="summary-sec">スキン毎に分類されたインデックスを格納する。</p>


<dl class="members-sec"><dt><span class="decl">int <span class="psymbol">vertex_id</span>
;
</span></dt>

<dd><p class="summary-sec">BoneSystem.skins[ <span class="psymbol">vertex_id</span>
 ] の頂点座標を使う。</p>


</dd>
<dt><span class="decl">SdefIndex[] <span class="psymbol">faces</span>
;
</span></dt>

<dd><p class="summary-sec">マテリアル毎に分類されている。</p>


</dd>
</dl>

</dd>
<dt><span class="decl">struct <span class="psymbol">SdefIndex</span>
;
</span></dt>

<dd><p class="bug-sec">モデルのスキンはトライアングルのみ。ラインは無視される。</p>

<dl class="members-sec"><dt><span class="decl">uint[] <span class="psymbol">faces</span>
;
</span></dt>

<dd><p class="summary-sec">GL_TRIANGLES;</p>


</dd>
</dl>

</dd>
<dt><span class="decl">BoneSet <span class="psymbol">mikotoModelToBoneSet</span>
(MikotoModel <span class="param">mm</span>
, jstring <span class="param">bone_name</span>
 = "".j);
</span></dt>

<dd><p class="summary-sec">MikotoModel から必要な情報を得る。
</p>

<p class="bug-sec">複数のルートボーンがあった場合はどうするのか？<br />

   → 現状では最初に見つかったルートボーンしか返しません。</p>

</dd>
</dl>


  </body>
</html>

