<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C/DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja">
  <head>
    <meta http-equiv = "Content-Type" content = "text/html; charset=utf-8" />
    <meta http-equiv = "Content-Style-Type" content = "text/css" />
    <meta http-equiv = "Content-Script-Type" content = "text/javascript" />
  </head>
  <body>
    <h1>sworks.mqo.bone_system</h1>
    <!-- Generated by Ddoc from src\sworks\mqo\bone_system.d -->
<p class='summary-sec'>MikotoModel を動かす為にボーンを準備する。
</p>
<span class='summary-header-sec version-sec'>0.0001(dmd2.062)
</span><br />

<span class='summary-header-sec date-sec'>2013-Mar-27 03:45:29
</span><br />

<span class='summary-header-sec authors-sec'>KUMA
</span><br />

<span class='summary-header-sec license-sec'>CC0</span><br />


<dl class='module-members-sec'><dt><span class='decl'><a name="VertexLayoutDescriptor"></a>struct <span class='psymbol'>VertexLayoutDescriptor</span>;
<br />
<a name="VLD_POSITION"></a>VertexLayoutDescriptor <span class='psymbol'>VLD_POSITION</span>;
<br />
<a name="VLD_NORMAL"></a>VertexLayoutDescriptor <span class='psymbol'>VLD_NORMAL</span>;
<br />
<a name="VLD_TEXTURE"></a>VertexLayoutDescriptor <span class='psymbol'>VLD_TEXTURE</span>;
<br />
<a name="VLD_MATRIX"></a>VertexLayoutDescriptor <span class='psymbol'>VLD_MATRIX</span>;
<br />
<a name="VLD_INFLUENCE"></a>VertexLayoutDescriptor <span class='psymbol'>VLD_INFLUENCE</span>;
</span></dt>
<dd><p class='summary-sec'>頂点座標を格納する構造体の定義に使う。
</p>
<b>Example:</b><br />

<pre class="d_code"> <span class='dkeyword'><span class='dkeyword'>struct</span></span> Vertex
 {
     @VLD_POSITION <span class='dkeyword'><span class='dkeyword'>float</span></span>[3] pos;    <span class='dcomment'>// 頂点座標
</span>     @VLD_NORMAL   <span class='dkeyword'><span class='dkeyword'>float</span></span>[3] normal; <span class='dcomment'>// 法線ベクトル
</span> }
</pre>
<br />
<br />


</dd>
<dt><span class='decl'><a name="AttributeConnector"></a>struct <span class='psymbol'>AttributeConnector</span>(T, alias ATTR);
</span></dt>
<dd><p class='summary-sec'>構造体 T のうち、ATTR の UDA を持つ(最初の)メンバへのアクセスに。
</p>
<b>Example:</b><br />

<pre class="d_code"> Vertex v; <span class='dcomment'>// 上記の構造体。
</span> <span class='dkeyword'><span class='dkeyword'>alias</span></span> pos_connector = <u>AttributeConnector</u>!( Vertex, VLD_POSITION );
 pos_connector(v) = [ 3.0, 4.0, 5.0 ]; <span class='dcomment'>// v.pos へアクセスできる。
</span></pre>
<br />
<br />


<dl class='members-sec'><dt><span class='decl'><a name="opCall"></a>inout(TYPE) <span class='psymbol'>opCall</span>(ref inout(T) <span class='param'>t</span>);
</span></dt>
<dd><p class='summary-sec'>UDA ATTR を持つメンバを得る。そんなメンバがない場合は <span class='dkeyword'>assert</span>(0);</p>

</dd>
</dl>
</dd>
<dt><span class='decl'><a name="BoneSet"></a>struct <span class='psymbol'>BoneSet</span>(VERTEX);
</span></dt>
<dd><p class='summary-sec'>ボーンの名前(マテリアル名)と BoneSystem.bones でのインデックス値を紐付けするための一時オブジェクト。<br />

 MikotoMotion のモーションを適用する際に参照される。<br />
</p>

<dl class='members-sec'><dt><span class='decl'><a name="bsys"></a>BoneSystem <span class='psymbol'>bsys</span>;
</span></dt>
<dd><p class='summary-sec'>対象となる BoneSystem</p>

</dd>
<dt><span class='decl'><a name="skins"></a>VERTEX[][] <span class='psymbol'>skins</span>;
</span></dt>
<dd><p class='summary-sec'>bones で使われる全スキン。由来する ObjectChunk 毎に分類してある。</p>

</dd>
<dt><span class='decl'><a name="bone_id"></a>int[jstring] <span class='psymbol'>bone_id</span>;
</span></dt>
<dd><p class='summary-sec'>マテリアル名 -&gt; インデックス</p>

</dd>
</dl>
</dd>
<dt><span class='decl'><a name="BoneSystem"></a>class <span class='psymbol'>BoneSystem</span>;
</span></dt>
<dd><p class='summary-sec'>ルートボーンとその子ボーンを管理する。<br />

</p>
<p class='bug-sec'>頂点インデックス/マテリアル情報は、<span class='psymbol'>BoneSystem</span> が管理している。(なんとなく違和感があるので変えるかも。)<br />

   Bone 下にスキンのインデックス、マテリアル情報も持たせている。</p>

<dl class='members-sec'><dt><span class='decl'><a name="BoneSystem.bones"></a>Bone[] <span class='psymbol'>bones</span>;
</span></dt>
<dd><p class='summary-sec'>このシステムに含まれる全てのボーン。roots も含まれる。</p>

</dd>
<dt><span class='decl'><a name="BoneSystem.roots"></a>Bone[] <span class='psymbol'>roots</span>;
</span></dt>
<dd><p class='summary-sec'>bones のうち、親ボーンを持たないボーン</p>

</dd>
<dt><span class='decl'><a name="BoneSystem.world_translate"></a>TranslateMotion <span class='psymbol'>world_translate</span>;
</span></dt>
<dd><p class='summary-sec'>ローカルワールド座標の平行移動運動</p>

</dd>
<dt><span class='decl'><a name="BoneSystem.world_rotate"></a>RotateMotion <span class='psymbol'>world_rotate</span>;
</span></dt>
<dd><p class='summary-sec'>ローカルワールド座標の回転移動運動</p>

</dd>
<dt><span class='decl'><a name="BoneSystem.this"></a> this(Bone[] <span class='param'>roots</span>, Bone[] <span class='param'>bones</span>);
</span></dt>
<dd><b>Params:</b><br />
<table border='1' cellpadding='8' cellspacing='0' frame='void' rules='rows' class='params'><tr><td class='params_id'>Bone[] <span class='param'>bones</span></td>
<td><span class='param'>bones</span>[0] がルートとする。</td></tr>
</table><br />


</dd>
<dt><span class='decl'><a name="BoneSystem.update"></a>void <span class='psymbol'>update</span>(float <span class='param'>f</span>);
</span></dt>
<dd><p class='summary-sec'>システムの変換行列を更新する。</p>

</dd>
</dl>
</dd>
<dt><span class='decl'><a name="Bone"></a>class <span class='psymbol'>Bone</span>;
</span></dt>
<dd><p class='summary-sec'>Mikoto のボーン。最長辺の対角が原点。<br />

 第二長辺が、Z軸正の向き。<br />

 最短辺と第二長辺の外積が X軸正の向きになっていると思われる。たぶん。<br />

</p>
<p class='bug-sec'>現在スキンのインデックス値も保持しているが、なんとなく違和感があるので変えるかも。<br />
</p>

<dl class='members-sec'><dt><span class='decl'><a name="Bone.id"></a>int <span class='psymbol'>id</span>;
</span></dt>
<dd><p class='summary-sec'><del>0 がルートとなる、</del>ボーンの ID。BoneSystem.bones のインデックス値。</p>

</dd>
<dt><span class='decl'><a name="Bone.parent"></a>Bone <span class='psymbol'>parent</span>;
</span></dt>
<dd><p class='summary-sec'>親ボーン。</p>

</dd>
<dt><span class='decl'><a name="Bone.children"></a>Bone[] <span class='psymbol'>children</span>;
</span></dt>
<dd><p class='summary-sec'>子ボーン。</p>

</dd>
<dt><span class='decl'><a name="Bone.neighbours"></a>Bone[] <span class='psymbol'>neighbours</span>;
</span></dt>
<dd><p class='summary-sec'>Anchor が干渉しあう Bone。自身は含まれない。</p>

</dd>
<dt><span class='decl'><a name="Bone.brothers"></a>Bone[] <span class='psymbol'>brothers</span>;
</span></dt>
<dd><p class='summary-sec'>ボーンの原点を同じくする弟ボーン。自身は含まれない。Materialチャンクで先に出てくるBoneが兄(たぶん)。</p>

</dd>
<dt><span class='decl'><a name="Bone.localize"></a>Tranf <span class='psymbol'>localize</span>;
</span></dt>
<dd><p class='summary-sec'>兄弟ボーンは平行移動のみ共有する。
 一般ワールド座標 -&gt; origin を原点とするローカル座標への変換</p>

</dd>
<dt><span class='decl'><a name="Bone.globalize"></a>Vector3f <span class='psymbol'>globalize</span>;
</span></dt>
<dd><p class='summary-sec'>ローカル座標 -&gt; 一つ上のボーンのローカル座標へ。</p>

</dd>
<dt><span class='decl'><a name="Bone.currentGlobalize"></a>Tranf <span class='psymbol'>currentGlobalize</span>;
</span></dt>
<dd><p class='summary-sec'>アニメーション用にアップデートされる。</p>

</dd>
<dt><span class='decl'><a name="Bone.transform"></a>Matrix4f <span class='psymbol'>transform</span>;
</span></dt>
<dd><p class='summary-sec'>変換行列の最終的な変形結果が格納される。<br />

 シェーダなどから、これを参照する。</p>

</dd>
<dt><span class='decl'><a name="Bone.translation"></a>TranslateMotion <span class='psymbol'>translation</span>;
<br />
<a name="Bone.rotation"></a>RotateMotion <span class='psymbol'>rotation</span>;
</span></dt>
<dd><p class='summary-sec'>現在適用中のモーション。<del>ルートボーン以外は平行移動しない。</del>&lt;-これはウソ。ボーンの原点を右クリ、ロック解除で移動できました。<br />

 ボーンの先端(ローカル座標のZ軸正の向き)がワールド座標の Z軸正の向きと一致する位置からの回転を示している。</p>

</dd>
<dt><span class='decl'><a name="Bone.bbox"></a>OBBox <span class='psymbol'>bbox</span>;
</span></dt>
<dd><p class='summary-sec'>頂点を内包するバウンディングボックス。当り判定用</p>

</dd>
<dt><span class='decl'><a name="Bone.centering"></a>Vector3f <span class='psymbol'>centering</span>;
</span></dt>
<dd><p class='summary-sec'>当り判定用</p>

</dd>
<dt><span class='decl'><a name="Bone.parts"></a>SdefPart[] <span class='psymbol'>parts</span>;
</span></dt>
<dd><p class='summary-sec'>このボーンに所属するモデル。スキン毎に分類されている。</p>

</dd>
<dt><span class='decl'><a name="Bone.this"></a> this(int <span class='param'>id</span>, Vector3f[] <span class='param'>boneV</span>, uint[] <span class='param'>boneF</span>, Bone <span class='param'>parent</span>);
</span></dt>
<dd><p class='summary-sec'>vertex[ face[0] ] が原点、vertex[ face[1] ] がボーン先端。</p>

</dd>
<dt><span class='decl'><a name="Bone.update"></a>void <span class='psymbol'>update</span>(float <span class='param'>f</span>, ref const(Tranf) <span class='param'>parent_globalize</span>);
</span></dt>
<dd><p class='summary-sec'>transform を更新する。</p>

</dd>
<dt><span class='decl'><a name="Bone.addNormalVector"></a>void <span class='psymbol'>addNormalVector</span>(VERTEX)(VERTEX[][] <span class='param'>skins</span>);
</span></dt>
<dd><p class='summary-sec'>法線ベクトルを準備する。</p>

</dd>
</dl>
</dd>
<dt><span class='decl'><a name="SdefPart"></a>struct <span class='psymbol'>SdefPart</span>;
</span></dt>
<dd><p class='summary-sec'>スキン毎に分類されたインデックスを格納する。</p>

<dl class='members-sec'><dt><span class='decl'><a name="SdefPart.vertex_id"></a>int <span class='psymbol'>vertex_id</span>;
</span></dt>
<dd><p class='summary-sec'>BoneSet.skins[ <span class='psymbol'>vertex_id</span> ] の頂点座標を使う。</p>

</dd>
<dt><span class='decl'><a name="SdefPart.faces"></a>SdefFace[] <span class='psymbol'>faces</span>;
</span></dt>
<dd><p class='summary-sec'>(備忘 なんで配列そのものでなくインデックス値で保持してるかというとヴァーテックスオブジェクトとか使い安いように。)
 マテリアル毎に分類されている。</p>

</dd>
<dt><span class='decl'><a name="SdefPart.addNormalVector"></a>void <span class='psymbol'>addNormalVector</span>(VERTEX)(VERTEX[] <span class='param'>v</span>);
</span></dt>
<dd><p class='summary-sec'>法線ベクトルを準備する。</p>

</dd>
</dl>
</dd>
<dt><span class='decl'><a name="SdefFace"></a>struct <span class='psymbol'>SdefFace</span>;
</span></dt>
<dd><p class='bug-sec'>モデルのスキンはトライアングルのみ。ラインは無視される。</p>

<dl class='members-sec'><dt><span class='decl'><a name="SdefFace.index"></a>uint[] <span class='psymbol'>index</span>;
</span></dt>
<dd><p class='summary-sec'>GL_TRIANGLES;</p>

</dd>
</dl>
</dd>
<dt><span class='decl'><a name="mikotoModelToBoneSet"></a>BoneSet!(VERTEX) <span class='psymbol'>mikotoModelToBoneSet</span>(VERTEX)(MikotoModel <span class='param'>mm</span>, jstring <span class='param'>bone_name</span> = "".j);
</span></dt>
<dd><p class='summary-sec'>MikotoModel から必要な情報を得る。
</p>
<p class='bug-sec'>複数のルートボーンがあった場合はどうするのか？<br />

   <del>→ 現状では最初に見つかったルートボーンしか返しません。</del>(ver 0.0014以降)<br />

   複数のルートボーンを保持した BoneSystem を返すようになりました。</p>

</dd>
</dl>

  </body>
</html>

